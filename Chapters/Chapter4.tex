% Chapter 4
\chapter{Effects and equaliser} % Main chapter title
\label{Chapter4} % For referencing the chapter elsewhere, use \ref{Chapter1} 
\lhead{Chapter 4. \emph{Effects and equaliser}}
\textsl{Written by Frederik De Greef}
%----------------------------------------------------------------------------------------
\section{Overdrive}
\subsection{Overdrive function}
The overdrive effect amplifies the audio signal in a non-linear way. There are different possible schemes, we used the three layer non-linear soft saturation scheme below. The treshold value is set at 1/3, given that the input audio values are between -1 and 1. 
\[ f(x) = \left\{
\begin{array}{ll}
2x & \mbox{if $0 \leq x < \frac{1}{3}$}\\
\frac{3-(2-3x)^{2}}{3} & \mbox{if $ \frac{1}{3} \leq x < \frac{2}{3}$}\\
1 & \mbox{if $ \frac{2}{3} \leq x \leq 1$}
\end{array} \right. \]
\begin{itemize}
\item In the lower third the output is linear - multiplied by 2. for $\frac{2}{3} \leq x \leq 1$
\item In the middle third there is a non-linear (quadratic) output response
\item Above $\frac{2}{3}$ the output is set to 1. 
\end{itemize}
Image \ref{fig:over} below shows the effect of the overdrive on an audio sample shown in the time domain. The blue signal is the original, the red signal is overdriven signal. (Time on the x-axis, amplitude on the y-axis.)
\begin{figure}[htbp]
\centering
\includegraphics[height=6.5cm]{over}
\rule{30em}{0.5pt}
\caption{Effect of overdrive in time domain}
\label{fig:over}
\end{figure}
Bringing this non-linearity in the signal is called clipping. Clipping is a process that produces frequencies not originally present in the audio signal. 
These frequencies can either be ''harmonic", meaning they are whole number multiples of the signal's original frequencies, or ''inharmonic", meaning dissonant odd-order overtones. \\
Setting the treshold value also determines wich type of clipping is applied. Increasing the treshold value will result in a softer clipping. Whereas decreasing the treshold value wil result in a harder clipping. When a treshold value of 1 is defined, there is no overdrive applied. The output remains the original signal. \\ \\
The hardness or softness of the clipping matters. Hard clipping results when the output wave equals the input up/down to a certain level, then stays at the clipping level until the input drops below the clipping level again, giving perfectly flat tops and bottoms to the clipped output. Soft clipping has no abrupt clipping level, but gently rounds the top/bottom of the output wave so the waveform is "softly" rounded on top/bottom, not flat-topped.\\
Soft clipping emphasizes the lower- order harmonics, the third and fifth, etc. Hard clipping has a mix slewed to the higher order seventh and up harmonics, which are harsher sounding. \\
In the figure \ref{fig:over1}, a normal sinewave with amplitude 1 is shown after beeing processed by the overdrive effect with a threshold equal to 1. With a treshold of 0.5 there is a small soft clipping visible, see figure \ref{fig:over2}. Both images have time on the x-axis and amplitude on the y-axis.
\begin{figure}[ht]
  \hfill
  \begin{minipage}[t]{.45\textwidth}
    \begin{center}  
      \epsfig{file=over1, scale=0.45}
      \caption{Overdrive threshold 1}
      \label{fig:over1}
    \end{center}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{.45\textwidth}
    \begin{center}  
      \epsfig{file=over2, scale=0.45}
      \caption{Overdrive threshold 0.5}
      \label{fig:over2}
    \end{center}
  \end{minipage}
  \hfill
\end{figure}
\subsubsection{Influence of the overdrive effect on the frequency spectrum}
To test the effects of the overdrive effect on signals, a few examples are fed into a Fast Fourier Transform (FFT) application. We test the FFT with the following signal: 
\begin{equation}
\mathrm{y(t) = 0.7 sin(2\pi \cdot 50t) + sin(2\pi \cdot 120t)}
\end{equation}
This signal combines a sinewave of frequency 50 Hz and amplitude 0.7 with a sinewave of frequency 120 Hz and amplitude 1. When the FFT is finished and plotted,figure \ref{fig:over3} below is the result.
\begin{figure}[htbp]
\centering
\includegraphics[height=5.5cm]{over3}
\rule{30em}{0.5pt}
\caption{FFT of a basic signal}
\label{fig:over3}
\end{figure}
The graph shown in figure \ref{fig:over4} the FFT of an overdrive with treshold equal to 0.1 on a sinewave with frequency 50hz. We can clearly see that there are only odd harmonics in the frequency spectrum, this is because the overdrive effect was set to symmetrical clipping.
%\begin{figure}[htbp]
%\centering
%\includegraphics[height=5.5cm]{over4}
%\rule{30em}{0.5pt}
%\caption{FFT symmetric clipping}
%\label{fig:over4}
%\end{figure}
\subsubsection{Symmetrical clipping}
For a given input waveform, say a sine wave, the tops and bottoms of the waveform are clipped equally, symmetrically. For a simple sine wave, symmetrical clipping generates only odd-order harmonics, giving a reedy, or raspy sound to the resultant waveform. 
\subsubsection{Asymmetrical clipping}
The top(or bottom) of the waveform is clipped more than the bottom (top) half. This causes the generation of both even and odd harmonics, in contrast to symmetrical clipping's odd-order only. The even harmonics are smoother and more musical sounding, not as harsh as the odd ones. The hardness of the clipping and the degree of asymmetry affect the sound. The more asymmetrical, the more pronounced the even-order harmonics, the harsher the clipping, the more the harmonics are slewed toward higher orders. \\
The graph in figure \ref{fig:over5} shows the Fourier transform of a the same signal, this time overdriven using asymmetrical clipping. Here the part of the sinewave above the x-axis was clipped using the same function as in the symmetrical clipping. The part of the sinewave below the x-axis is still the original. As we can see in the graph, using the asymmetrical clipping generates not only the odd but also the even harmonics. These even harmonics give an other type of sound.
\begin{figure}[ht]
  \hfill
  \begin{minipage}[t]{.45\textwidth}
    \begin{center}  
      \epsfig{file=over4, scale=0.40}
      \caption{Symmetric clipping}
      \label{fig:over4}
    \end{center}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{.45\textwidth}
    \begin{center}  
      \epsfig{file=over5, scale=0.40}
      \caption{Asymmetric clipping}
      \label{fig:over5}
    \end{center}
  \end{minipage}
  \hfill
\end{figure}
%\begin{figure}[htbp]
%\centering
%\includegraphics[height=5.5cm]{over5}
%\rule{30em}{0.5pt}
%\caption{FFT asymmetric clipping}
%\label{fig:over5}
%\end{figure}
%----------------------------------------------------------------------------------------
\section{Equaliser}
\subsection{Design of the equaliser}
The equaliser consists of three filters:
\begin{itemize}
\item Lowpass filter with cutoff frequency equal to 800Hz.
\item Bandpass filter with cutoff frequencies equal to 800Hz and 6000Hz.
\item Highpass filter with cutoff frequency equal to 6000Hz.
\end{itemize}
All the filters are constructed as FIR (Finite impulse response) with order 100. 
The filter components are created in MATLAB using the fir1 command.\\
The architecture of these Finite impulse response filters is displayed in figure \ref{fig:equal}.
\begin{figure}[htbp]
\centering
\includegraphics[height=5.5cm]{equal}
\rule{30em}{0.5pt}
\caption{Architecture of the equaliser}
\label{fig:equal}
\end{figure}
\subsection{Amplitude response of the FIR filters}
\begin{figure}[htbp]
\centering
\includegraphics[height=5.5cm]{equal1}
\rule{30em}{0.5pt}
\caption{Magnitude response lowpass filter}
\label{fig:equal1}
\end{figure}
\begin{figure}[htbp]
\centering
\includegraphics[height=5.5cm]{equal2}
\rule{30em}{0.5pt}
\caption{Magnitude response bandpass filter}
\label{fig:equal2}
\end{figure}
\begin{figure}[htbp]
\centering
\includegraphics[height=5.5cm]{equal3}
\rule{30em}{0.5pt}
\caption{Magnitude response highpass filter}
\label{fig:equal3}
\end{figure}
%----------------------------------------------------------------------------------------
\subsection{Testing of the equalizer in MATLAB}
The equalizer has been tested by processing blocks of 1024 samples filled with white gaussian noise, the result has been fed into an FFT. Blocks are processed with the equalizer settings displayed in the caption of figures \ref{fig:equal4}, \ref{fig:equal5} and \ref{fig:equal6}.\\
\begin{figure}[htbp]
\centering
\includegraphics[height=5.5cm]{equal4}
\rule{30em}{0.5pt}
\caption{Gain$_{LP}$ = 0, Gain$_{BP}$ = 1, Gain$_{HP}$ = 1}
\label{fig:equal4}
\end{figure}
\begin{figure}[ht]
  \hfill
  \begin{minipage}[t]{.45\textwidth}
    \begin{center}  
      \epsfig{file=equal5, scale=0.40}
      \caption{Gain$_{LP}$ = 1, \\ Gain$_{BP}$ = 0, Gain$_{HP}$ = 1}
      \label{fig:equal5}
    \end{center}
  \end{minipage}
  \hfill
  \begin{minipage}[t]{.45\textwidth}
    \begin{center}  
      \epsfig{file=equal6, scale=0.40}
      \caption{Gain$_{LP}$ = 1, \\ Gain$_{BP}$ = 1, Gain$_{HP}$ = 0}
      \label{fig:equal6}
    \end{center}
  \end{minipage}
  \hfill
\end{figure}
The equaliser settings can be changed in the interface, using the sliders for all the filters where a value between 0 and 10 can be set. The interface will respond by sending  separate gain integers  to the dsp board. Here every filter is independently multiplied by it's gain and devided by 10. \\
Afterwards all the filter coefficients are added together to deliver the 101 final coefficients for the selected equaliser setting. These values will than be used to process the sample blocks entering the equaliser.\\
This is not the traditional way of FIR filtering, normally different coefficients are  created for every specific equalizer setting.  This way of working saves lots of processing power. \\ \\
Because the FIR filters work with samples 'from the past', every sample block will first be prepadded with the 100 last samples of the previous block.  These are stored in the so called prepad array. After the incomming block is prepadded, it 100 last samples will be stored in the prepad array. In this way always 1024 samples are loaded into the filer, this filter uses 1124 samples to create a 1024 sample outputblock. \\
%----------------------------------------------------------------------------------------
\subsection{Problems and solutions}
\begin{itemize}
\item \textbf{Problem:} The overdrive effect can only generate odd harmonics.
\begin{itemize}
\item \textbf{Solution:} An extra option is added, which lets the user choose between 'symclip' (odd harmonics) or 'asymclip' (even harmonics).
\end{itemize}
%-----------------------
\item \textbf{Problem:} The interface was not able to generate specific filter coefficients for all the different equalizer settings.
\begin{itemize}
\item \textbf{Solution:} Solved by designing a filtering method which can use 'static' coefficients. Here the interface only has to send the different gain integers to the dsp board.
\end{itemize}
%-----------------------
\item \textbf{Problem:} The FIR filter goes back 100 samples in the past to proces the current sample. 
\begin{itemize}
\item \textbf{Solution:} An extra 'prepad' array is added, initiated by zeros when the equalizer starts, and always saves the last 100 samples of the 1024 sample block. Allowing the filter to use these samples.
\end{itemize}
%-----------------------
\item \textbf{Problem:} The filter coefficients for the highpass filter are to large for the 32-bit double values, the dsp board uses.
\begin{itemize}
\item \textbf{Solution:} We first changed the compiler settings to use 64-bit memory for the values, but this caused the rest of the program to stop working. It was finally solved by creating new filter coefficients for the high pass filter who where small enough to fit in 32 bits.
\end{itemize}
%-----------------------
\item \textbf{Problem:} The equalizer added an extra noise to the signal
\begin{itemize}
\item \textbf{Solution:} The problem here was that the prepad array was not filled correctly, so it prepadded every sample block with 100 zeros as it was initiated. The last 100 samples where always saved in a wrong place in the memory. The use of pointers for this storing and fetching caused the program not to crash during runtime. Correcting the save location solved this.
\end{itemize}
\item \textbf{Problem:} The bandpass filter acts as a highpass from its first cutoff frequency
\begin{itemize}
\item \textbf{Solution:} at implement
\end{itemize}
\end{itemize}
